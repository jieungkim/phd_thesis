\section{Top Level Theorem in CertiKOS}
\label{chapter:certikos:sec:top-level-theorem}


Using all results described in this chapter, 
we finally show the top-level single theorem for the correctness of $\certikos$, 
described in Theorem~\ref{theorem:chapter:certikos:contextual-refinement-theorem-for-certikos}. 
\begin{theorem}[Contextual Refinement Theorem for $\certikos$]
\label{theorem:chapter:certikos:contextual-refinement-theorem-for-certikos}
Let's assume that $tid$ is a valid thread ID, $\oracle_{tid}$ is an
environmental context for thread $tid$, and $\codeinmath{Ctxt}$ is a
 context program that runs on top of the $certikos$. 
 Then, we want to prove that 
 \begin{center}
\begin{tabular}{c}
$\semwmachine{\codeinmath{MBoot}}{\codeinmath{CertiKOS} \oplus \codeinmath{Ctxt}}{\codeinmath{mach}_{\codeinmath{x86mc}}} \refines_{R_{\codeinmath{certikos}}} \semwmachine{\codeinmath{TSyscall}[tid, \oracle_{tid}]}{\codeinmath{Ctxt}}{{\codeinmath{mach}_{\codeinmath{x86thrd}}}}$\\
\end{tabular}
\end{center}
\end{theorem}
The proof of this theorem is 
straightforward with 
the lemmas that we have stated in previous sections.
%
%\begin{proof}
%First, we assume that 
%
%\end{proof}

In $\coq$, the theorem is stated as follows:
%
%\begin{lstlisting}[language=C]
%  Theorem CertiKOS_correct:
%    forall (s: stencil) (CTXT: LAsm.module) k1 k2 p combined_program user_program,
%      genv_next s = init_nb ->
%      CertiKOS.per_thread_certikos = OK k1 ->
%      CertiKOS.per_cpu_certikos = OK k2 ->
%      forall Hmp: make_program s ((CTXT <@$\oplus$@> k1) <@$\oplus$@> k2) (MBoot.mboot <@$\oplus$@> L64) = OK combined_program,
%      make_program s (CTXT <@$\oplus$@> k1) (PHThread.phthread <@$\oplus$@> L64) = OK p ->
%      make_program s CTXT (TSysCall.tsyscall <@$\oplus$@> L64) = OK user_program ->
%      noglobvar p ->
%      inhabited
%        (backward_simulation
%           (HAsm.semantics (TSysCall.tsyscall <@$\oplus$@> L64) user_program)
%           (HWStepSemImpl.hwstep_semantics 
%             (Hmakege := make_program_globalenv _ _ _ _ Hmp)
%             (Genv.globalenv combined_program) s
%             ((CTXT <@$\oplus$@> k1) <@$\oplus$@> k2)
%             combined_program)).
%\end{lstlisting}
%and the proof is exactly same with the 

%\begin{figure}
%\includegraphics[width=\textwidth]{figs/certikos/layer_diagram}
%\caption{Layer Diagram for $\certikos$}
%\label{fig:chapter:certikos:layer-diagram-for-certikos}
%\jieung{Let's slightly modify it}
%\end{figure}


With the all ingredients in this chapter, 
connecting all proof pieces in $\certikos$ is available;
thus we provide a single correctness theorem for $\certikos$
as well as connecting proofs
for the theorem.
