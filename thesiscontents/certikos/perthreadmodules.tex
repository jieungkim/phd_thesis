\section{Per Thread Modules}
\label{chapter:certikos:sec:per-thread-modules}

Due to the restrictions that we mentioned,
we only includes small pieces of our operating system in oure per-thread modules.

\paragraph{IPC Module}

IPC is the module that provides the communication between threads.
It's communication is inter-thread/CPU, so all threads in our system can communicate with others if it does not exceed the capacity of our system. 

One reason of this module to be allocated in the thread local machine is that 
the receive function relies on the sleep function call to avoid busy waiting. 

\paragraph{Trap Handler Module}

The Trap handler module is providing the top-level API of our operating systems to users.  

\paragraph{Connecting All Layers in Per-Thread Modules}

All the ingredients that we have mentioned in here is to provide a single correctness 
theorem for the all system. 


\begin{lstlisting}[language=C]
  Theorem Per_Thread_CertiKOS_correct:
    forall (s: stencil) (CTXT: LAsm.module) kernel combined_program user_program
           (builtin_idents_norepet_prf: CompCertBuiltins.BuiltinIdentsNorepet),
      CertiKOS.per_thread_certikos = OK kernel ->
      make_program s (CTXT <@$\oplus$@> kernel) (PHThread.phthread  <@$\oplus$@>  L64) = OK combined_program ->
      make_program s CTXT (TSysCall.tsyscall  <@$\oplus$@>  L64) = OK user_program ->
      inhabited
        (backward_simulation
           (HAsm.semantics (TSysCall.tsyscall  <@$\oplus$@>  L64) user_program)
           (HAsm.semantics (PHThread.phthread <@$\oplus$@> L64) combined_program)).
\end{lstlisting}